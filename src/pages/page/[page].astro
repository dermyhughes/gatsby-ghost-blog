---
import Layout from '../../components/Layout.astro';
import MetaData from '../../components/meta/MetaData.astro';
import Pagination from '../../components/Pagination.astro';
import PostCard from '../../components/PostCard.astro';
import PostFeed from '../../ui/posts/PostFeed.astro';
import { buildPaginationContext, getHomePagePath, paginateItems, POSTS_PER_PAGE } from '../../lib/content';
import { getAllPosts, getGhostSettings } from '../../lib/ghost';
import { canonicalFromPath } from '../../lib/site';

export async function getStaticPaths() {
  const posts = await getAllPosts();
  const totalPages = Math.ceil(posts.length / POSTS_PER_PAGE);

  return Array.from({ length: Math.max(totalPages - 1, 0) }, (_, index) => ({
    params: { page: String(index + 2) },
  }));
}

const pageNumber = Number(Astro.params.page);
const settings = await getGhostSettings();
const posts = await getAllPosts();

const { items: paginatedPosts, numberOfPages } = paginateItems(posts, POSTS_PER_PAGE, pageNumber);
const pagination = buildPaginationContext(pageNumber, numberOfPages, getHomePagePath);
const currentPath = getHomePagePath(pageNumber);
const canonical = canonicalFromPath(currentPath);
---

<Layout settings={settings} currentPath={currentPath}>
  <Fragment slot='head'>
    <MetaData settings={settings} canonical={canonical} />
  </Fragment>

  <div class='container'>
    <PostFeed>
      {paginatedPosts.map((post) => <PostCard post={post} />)}
    </PostFeed>
    <Pagination {...pagination} />
  </div>
</Layout>
