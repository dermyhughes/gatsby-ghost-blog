---
import ThemeToggle from './ThemeToggle';
import Navigation from './Navigation.astro';
import SocialLinks from './SocialLinks.astro';
import type { GhostSettings } from '../lib/ghost-types';

import '../styles/app.scss';

interface Props {
  settings: GhostSettings;
  currentPath: string;
  bodyClass?: string;
  isHome?: boolean;
  extraStyles?: string | null;
  extraHeadHtml?: string | null;
  extraFootHtml?: string | null;
}

const {
  settings,
  currentPath,
  bodyClass = '',
  isHome = false,
  extraStyles = null,
  extraHeadHtml = null,
  extraFootHtml = null,
} = Astro.props;

const descriptionParts = (settings.description || '')
  .split('.')
  .map((part) => part.trim())
  .filter(Boolean);

const currentYear = new Date().getFullYear();
---

<!doctype html>
<html lang={settings.lang || 'en'}>
  <head>
    <meta charset='utf-8' />
    <meta name='viewport' content='width=device-width,initial-scale=1' />
    <link rel='icon' href='/favicon.png' />
    <link rel='manifest' href='/manifest.webmanifest' />
    <meta name='theme-color' content='#15171A' />
    <script is:inline>
      (() => {
        const root = document.documentElement;
        let storedTheme = null;

        try {
          storedTheme = window.localStorage.getItem('preferred-theme');
        } catch (error) {
          storedTheme = null;
        }

        const theme =
          storedTheme === 'light' || storedTheme === 'dark'
            ? storedTheme
            : window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches
              ? 'dark'
              : 'light';

        root.dataset.theme = theme;
        root.style.colorScheme = theme;
      })();
    </script>
    <script>
      import Prism from 'prismjs';
      import 'prismjs/components/prism-typescript';
      import 'prismjs/components/prism-jsx';
      import 'prismjs/components/prism-tsx';

      const trustAllScripts = () => {
        const scriptNodes = document.querySelectorAll<HTMLScriptElement>(
          '.load-external-scripts script',
        );

        scriptNodes.forEach((node) => {
          const script = document.createElement('script');
          script.type = node.type || 'text/javascript';

          const source = node.getAttribute('src');
          if (source) {
            script.src = source;
          } else {
            script.textContent = node.textContent;
          }

          document.head.appendChild(script);
        });
      };

      const setScrollProgress = () => {
        const progress = document.getElementById('scroll-progress');
        if (!progress) return;

        const height = document.documentElement.scrollHeight - document.documentElement.clientHeight;
        const scrollTop = document.body.scrollTop || document.documentElement.scrollTop;
        progress.style.width = `${(scrollTop / height) * 100}%`;
      };

      window.addEventListener('scroll', setScrollProgress, { passive: true });
      window.addEventListener('load', () => {
        Prism.highlightAll();
        trustAllScripts();
        setScrollProgress();
      });
    </script>
    {settings.codeinjection_head && <Fragment set:html={settings.codeinjection_head} />}
    {extraHeadHtml && <Fragment set:html={extraHeadHtml} />}
    {settings.codeinjection_styles && <style is:inline set:html={settings.codeinjection_styles} />}
    {extraStyles && <style is:inline set:html={extraStyles} />}
    <slot name='head' />
  </head>
  <body class={bodyClass}>
    <div class='viewport'>
      <div class='viewport-top'>
        <header
          class='site-head'
          style={settings.cover_image ? `background-image: url(${settings.cover_image});` : undefined}
        >
          <div class='container'>
            {
              !isHome && (
                <div class='site-mast'>
                  <div class='site-nav-left'>
                    <Navigation data={settings.navigation || []} navClass='site-nav-item' currentPath={currentPath} />
                  </div>
                  <div class='site-mast-right mast-small'>
                    <div class='site-actions'>
                      <ThemeToggle client:load />
                      <SocialLinks isHome={false} />
                    </div>
                  </div>
                </div>
              )
            }

            {
              isHome && (
                <div>
                  <div class='site-banner'>
                    <h1 class='site-banner-title three-d' data-line={settings.title}>
                      {settings.title}
                    </h1>

                    <div class='site-banner-desc'>
                      {
                        descriptionParts.map((item) => (
                          <div class='highlight-container'>
                            <span class='highlight'>{item}.</span>
                          </div>
                        ))
                      }
                    </div>
                    <SocialLinks isHome />
                  </div>
                  <nav class='site-nav'>
                    <div class='site-nav-left'>
                      <Navigation data={settings.navigation || []} navClass='site-nav-item' currentPath={currentPath} />
                    </div>
                    <div class='site-nav-right'>
                      <div class='site-actions'>
                        <ThemeToggle client:load />
                      </div>
                    </div>
                  </nav>
                </div>
              )
            }
          </div>
        </header>
        <section aria-hidden='true' class='skewed' />
        <main id='site-main'>
          <slot />
        </main>
      </div>

      <div class='viewport-bottom'>
        <footer class='site-foot'>
          <div class='site-foot-nav container'>
            <div class='site-foot-nav-left'>
              <a href='/'>{settings.title}</a> Â©{currentYear}.
            </div>
            <div class='site-foot-nav-right'>
              <Navigation data={settings.navigation || []} navClass='site-foot-nav-item' currentPath={currentPath} />
            </div>
          </div>
        </footer>
      </div>
    </div>
    {settings.codeinjection_foot && <Fragment set:html={settings.codeinjection_foot} />}
    {extraFootHtml && <Fragment set:html={extraFootHtml} />}
  </body>
</html>
