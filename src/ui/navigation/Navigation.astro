---
import type { GhostNavigationItem } from '../../lib/ghost-types';
import { siteUrl } from '../../lib/site';

interface Props {
  data?: GhostNavigationItem[];
  currentPath: string;
  navClass?: string;
}

const { data = [], currentPath, navClass = 'site-nav-item' } = Astro.props;

const ensureTrailingSlash = (path: string) => {
  if (path === '/') {
    return '/';
  }

  return `${path.replace(/\/+$/, '')}/`;
};

const getInternalPath = (rawUrl: string) => {
  if (!rawUrl) {
    return null;
  }

  if (/^https?:\/\//i.test(rawUrl)) {
    if (rawUrl.startsWith(siteUrl)) {
      const parsed = new URL(rawUrl);
      return ensureTrailingSlash(parsed.pathname || '/');
    }

    return null;
  }

  return ensureTrailingSlash(rawUrl.startsWith('/') ? rawUrl : `/${rawUrl}`);
};

const normalizedCurrentPath = ensureTrailingSlash(currentPath);
---

{
  data.map((navItem) => {
    const internalPath = getInternalPath(navItem.url);

    if (!internalPath) {
      return (
        <a class={navClass} href={navItem.url} target='_blank' rel='noopener noreferrer'>
          {navItem.label}
        </a>
      );
    }

    const isHome = internalPath === '/';
    const isHomeActive = isHome && (normalizedCurrentPath === '/' || normalizedCurrentPath.startsWith('/page/'));
    const isSectionActive =
      !isHome &&
      (normalizedCurrentPath === internalPath ||
        normalizedCurrentPath.startsWith(`${internalPath.replace(/\/$/, '')}/`));

    const isActive = isHomeActive || isSectionActive;

    return (
      <a class={`${navClass}${isActive ? ' active-link' : ''}`} href={internalPath}>
        {navItem.label}
      </a>
    );
  })
}

<style is:global lang='scss'>
@use '../styles/navigation-contract' as nav;

@include nav.nav-item-contract;
</style>
